<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=drawing&callback=initMap"async defer></script>
    <script src="javascript/initMap.js"></script>
    <script src="javascript/countryCodes.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body>
    <div id="options">
      <p>country code</p>
      <select id="country-codes"></select>
      <p>search text</p>
      <input id="search-field" type="text" />
      <p>results </p>
      <select id="results"></select>

      <script>

          $('#search-field').keyup(function (e) {
            if (e.which == 13) {  // detect the enter key
              searchNominatim()
            }
          });

          $("#results").change(function(test){
            mapDefinition()
          });

      </script>
    </div>
    <div id="map"></div>
  </body>
</html>

<script>
searchNominatim = function(){
  results = {};
  var searchTerm= $('#search-field').val()
  var country = $("#country-codes").val()
  $.ajax({
    dataType: "json",
    type: "Get",
    url: "http://nominatim.openstreetmap.org/search.php?format=json&polygon_geojson=1&email=slummock@gmail.com&q=" + searchTerm + "&countrycodes="+country,
    success: function (data) {
      $("#results").empty()
      $.each(data,function(index, item){
        results[item.osm_id] = item;
        $("#results").append('<option value = "'+ item.osm_id +'">'+item.display_name+'</option>')
      })
      mapDefinition()
    }
  });
}

mapDefinition = function(){
  var key = $("#results").val();
  var object = results[key];
  if(typeof nominatimArea!="undefined")
  {
    nominatimArea.setMap(null)
    map.setCenter(new google.maps.LatLng(53.476822, -2.255360))
    map.setZoom(6)
  }
  if (object.geojson != null)
    drawGeoJson(object)  
}

drawGeoJson = function(data){

  map.data.forEach(function(feature) {
        map.data.remove(feature);
  });

  var feature = JSON.parse('{"type":"FeatureCollection","features":[{"type":"Feature"}]}');

  feature.features[0].geometry = data.geojson;

  map.data.addGeoJson(feature);
  map.data.setStyle({
    fillColor: 'green'
  });

  var boundingSw = new google.maps.LatLng(data.boundingbox[0], data.boundingbox[2]);
  var boundingNe = new google.maps.LatLng(data.boundingbox[1], data.boundingbox[3]);

  var boundingBox = new google.maps.LatLngBounds(boundingSw, boundingNe)
  map.fitBounds(boundingBox)
}
</script>